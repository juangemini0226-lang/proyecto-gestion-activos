<!DOCTYPE html>
{% load user_tags %}
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Gestión de Activos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
</head>
<body class="bg-light">

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="/">
        <i class="bi bi-box-seam"></i>
        Gestión de Activos
      </a>
      <div class="d-flex">
        {% if user.is_authenticated %}
          <span class="navbar-text me-3">
            Hola, <strong>{{ user.username }}</strong>
          </span>
          <form action="{% url 'accounts:logout' %}" method="post" class="d-flex">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-light">Cerrar Sesión</button>
          </form>
        {% endif %}
      </div>
    </div>
  </nav>

  <div class="container py-5">

    {% if user|has_group:"Operarios" and ordenes %}
      <div class="card shadow-sm mb-5">
        <div class="card-header">Mis Tareas Pendientes</div>
        <ul class="list-group list-group-flush">
          {% for orden in ordenes %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              Mantenimiento de <strong>{{ orden.activo.nombre }}</strong> ({{ orden.get_tipo_display }})
              <a href="{% url 'activos:checklist_mantenimiento' orden.id %}" class="btn btn-sm btn-info">
                Iniciar Tarea
              </a>
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <main>
      <div class="row g-4 justify-content-center">

        <!-- Escáner QR -->
        <div class="col-lg-4 col-md-6">
          <div class="card h-100 shadow-sm">
            <div class="card-body d-flex flex-column text-center">
              <i class="bi bi-qr-code-scan display-1 text-primary mb-3"></i>
              <h5 class="card-title">Escáner QR</h5>
              <p class="card-text flex-grow-1">
                Accede a la herramienta de escaneo para identificar un activo y consultar su información en tiempo real.
              </p>
              <a href="/escaner/" class="btn btn-primary mt-auto">Iniciar Escáner</a>
            </div>
          </div>
        </div>

        <!-- Órdenes de Trabajo -->
        {% if user.is_authenticated %}
        <div class="col-lg-4 col-md-6">
          <div class="card h-100 shadow-sm">
            <div class="card-body d-flex flex-column text-center">
              <i class="bi bi-tools display-1 text-primary mb-3"></i>
              <h5 class="card-title">Órdenes de Trabajo</h5>
              <p class="card-text flex-grow-1">
                Crea, asigna y gestiona OTs. Los operarios pueden consultar sus tareas asignadas.
              </p>
              <div class="d-grid gap-2 mt-auto">
                {% if user|has_group:"Supervisor" %}
                  <a href="{% url 'activos:ordenes_list' %}" class="btn btn-primary">Ver órdenes</a>
                {% endif %}
                {% if user|has_group:"Operarios" %}
                  <a href="{% url 'activos:mis_tareas' %}" class="btn btn-outline-secondary">Mis tareas</a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Panel de Admin -->
        {% if user.is_staff %}
          <div class="col-lg-4 col-md-6">
            <div class="card h-100 shadow-sm">
              <div class="card-body d-flex flex-column text-center">
                <i class="bi bi-person-fill-gear display-1 text-success mb-3"></i>
                <h5 class="card-title">Panel de Admin</h5>
                <p class="card-text flex-grow-1">
                  Gestiona los activos, usuarios y tareas de mantenimiento. Importa datos desde hojas de cálculo.
                </p>
                <a href="/admin/" class="btn btn-success mt-auto">Ir al Panel</a>
              </div>
            </div>
          </div>
        {% endif %}

        <!-- Agendar Mantenimiento + Alertas -->
        {% if user|has_group:"Supervisor" %}
          <div class="col-lg-4 col-md-6">
            <div class="card h-100 shadow-sm">
              <div class="card-body d-flex flex-column text-center">
                <i class="bi bi-calendar-plus display-1 text-info mb-3"></i>
                <h5 class="card-title">Agendar Mantenimiento</h5>
                <p class="card-text flex-grow-1">
                  Crea nuevas órdenes de trabajo de mantenimiento preventivo o correctivo para los activos.
                </p>
                <div class="d-grid gap-2 mt-auto">
                  <a href="{% url 'activos:agendar_mantenimiento' %}" class="btn btn-info">Agendar Ahora</a>

                  {% with n=alertas_abiertas|default:0 %}
                    <a href="{% url 'horometro_alertas' %}"
                       class="btn {% if n %}btn-danger{% else %}btn-outline-danger{% endif %}">
                      <i class="bi bi-exclamation-triangle me-1"></i>
                      Alertas
                      {% if n %}
                        <span class="badge text-bg-light ms-1">{{ n }}</span>
                      {% endif %}
                    </a>
                  {% endwith %}
                </div>
              </div>
            </div>
          </div>
        {% endif %}

        <!-- Aprobaciones -->
        {% if user|has_group:"Supervisor" %}
          <div class="col-lg-4 col-md-6">
            <div class="card h-100 shadow-sm border-warning">
              <div class="card-body d-flex flex-column text-center">
                <i class="bi bi-check2-square display-1 text-warning mb-3"></i>
                <h5 class="card-title">Aprobaciones</h5>
                <p class="card-text flex-grow-1">
                  Revisa y aprueba los mantenimientos completados por los operarios.
                </p>
                <a href="#" class="btn btn-warning mt-auto">Ver Pendientes</a>
              </div>
            </div>
          </div>
        {% endif %}

        <!-- Dashboard de Métricas (Horómetro) -->
        {% if user|has_group:"Supervisor" %}
          <div class="col-lg-4 col-md-6">
            <div class="card h-100 shadow-sm">
              <div class="card-body d-flex flex-column text-center">
                <i class="bi bi-bar-chart-line display-1 text-primary mb-3"></i>
                <h5 class="card-title">Dashboard de Métricas</h5>
                <p class="card-text flex-grow-1">
                  Visualiza la evolución del horómetro por activo y consulta el historial semana a semana.
                </p>
                <div class="d-grid gap-2 mt-auto">
                  <a href="{% url 'dashboard_horometro' %}" class="btn btn-primary">Ver Reportes</a>
                  <a href="{% url 'horometro_subir' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-upload me-1"></i> Cargar Horómetro (Excel)
                  </a>
                </div>
              </div>
            </div>
          </div>
        {% endif %}

      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
