{% extends "core/base.html" %}

{% block content %}
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h1 class="h5 mb-1">Checklist OT #{{ ot.id }} — {{ ot.activo.codigo }} / {{ ot.activo.nombre }}</h1>
      <div class="small text-muted">
        Estado:
        {% if ot.estado == 'PEN' %}
          <span class="badge text-bg-secondary">Pendiente</span>
        {% elif ot.estado == 'PRO' %}
          <span class="badge text-bg-info">En Progreso</span>
        {% elif ot.estado == 'REV' %}
          <span class="badge text-bg-warning">Pend. Revisión</span>
        {% elif ot.estado == 'COM' %}
          <span class="badge text-bg-success">Completada</span>
        {% endif %}
      </div>
    </div>

    <div class="ms-3" style="min-width:220px;">
      <div class="small mb-1">Avance: <strong>{{ ot.porcentaje_avance }}%</strong></div>
      <div class="progress" style="height:8px;">
        <!-- Quitamos {{ }} del style para que no marque error CSS -->
        <div class="progress-bar js-progress" 
             data-progress="{{ ot.porcentaje_avance|default:0 }}"
             role="progressbar"
             aria-valuenow="{{ ot.porcentaje_avance|default:0 }}" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
    </div>
  </div>

  <!-- Un solo form, sin anidar. Soporta guardar checklist y subir evidencias. -->
  <form method="post" class="mb-3" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th style="width: 56px;">OK</th>
            <th>Tarea</th>
            <th>Observaciones</th>
          </tr>
        </thead>
        <tbody>
          {% for det in items_checklist %}
          <tr>
            <td class="text-center">
              <input class="form-check-input" type="checkbox" name="tarea_{{ det.id }}"
                     {% if det.completado %}checked{% endif %}
                     {% if det.requiere_evidencia and not det.evidencias.all %}
                       disabled
                       title="Debes subir una evidencia para poder marcar esta tarea."
                     {% endif %}>
            </td>
            <td>
              <div class="fw-semibold">{{ det.tarea.nombre }}</div>
              {% if det.requiere_evidencia %}
                <span class="badge text-bg-dark">Requiere Evidencia</span>
              {% endif %}
            </td>
            <td>
              <textarea class="form-control form-control-sm" name="obs_{{ det.id }}" rows="1"
                        placeholder="Opcional">{{ det.observaciones|default_if_none:"" }}</textarea>
            </td>
          </tr>

          {% if det.requiere_evidencia %}
          <tr class="evidence-row">
            <td></td>
            <td colspan="2">
              <div class="p-2 border-top">
                <!-- En el mismo form: un input file por detalle -->
                <input type="hidden" name="detalle_id_{{ det.id }}" value="{{ det.id }}">
                <div class="d-flex gap-2 align-items-center mb-2">
                  <!-- Usa un nombre único por fila -->
                  <input type="file" name="archivo_{{ det.id }}" class="form-control form-control-sm" />
                  <button type="submit" name="upload_evidencia" value="{{ det.id }}"
                          class="btn btn-sm btn-outline-secondary" title="Subir Evidencia">
                    <i class="bi bi-upload"></i> Subir
                  </button>
                </div>

                <div class="small">
                  {% for evidencia in det.evidencias.all %}
                    <div class="d-flex align-items-center">
                      <a href="{{ evidencia.archivo.url }}" target="_blank" class="text-decoration-none">
                        <i class="bi bi-file-earmark-text me-1"></i>
                        {{ evidencia.archivo.name|truncatechars:35 }}
                      </a>
                      {% if evidencia.subido_por %}
                        <span class="text-muted ms-2">({{ evidencia.subido_por.username }})</span>
                      {% endif %}
                    </div>
                  {% empty %}
                    <span class="text-muted small">No hay evidencias subidas para esta tarea.</span>
                  {% endfor %}
                </div>
              </div>
            </td>
          </tr>
          {% endif %}
          {% empty %}
          <tr>
            <td colspan="3" class="text-center text-muted py-4">No hay ítems en el checklist.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-primary" type="submit" name="guardar_checklist" value="1">
        <i class="bi bi-save me-1"></i> Guardar cambios
      </button>
    </div>
  </form>

  <div class="d-flex gap-2 mt-2">
    <form method="post" action="{% url 'activos:cambiar_estado_ot' ot.id %}">
      {% csrf_token %}
      <input type="hidden" name="estado" value="REV">
      <button class="btn btn-warning" type="submit"
              {% if ot.porcentaje_avance < 100 or ot.estado != 'PRO' %}disabled{% endif %}>
        <i class="bi bi-arrow-right-circle me-1"></i> Enviar a revisión
      </button>
    </form>

    {% if ot.estado == 'REV' %}
    <form method="post" action="{% url 'activos:cambiar_estado_ot' ot.id %}">
      {% csrf_token %}
      <input type="hidden" name="estado" value="COM">
      <button class="btn btn-success" type="submit">
        <i class="bi bi-check2-circle me-1"></i> Completar OT
      </button>
    </form>
    {% endif %}
  </div>
</div>

<!-- Pequeño script para aplicar el ancho sin poner {{ }} dentro de style -->
<script>
  document.querySelectorAll('.js-progress').forEach(function (el) {
    var pct = parseFloat(el.dataset.progress || '0');
    if (!isNaN(pct)) { el.style.width = pct + '%'; }
  });
</script>
{% endblock %}
