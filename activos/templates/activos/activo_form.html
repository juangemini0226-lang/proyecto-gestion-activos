{% extends "core/base.html" %}
{% load activos_extras %}
{% block content %}
<div class="container py-4">
  <h1 class="h5 mb-3">{% if activo %}Editar Activo{% else %}Nuevo Activo{% endif %}</h1>
  <form method="post" enctype="multipart/form-data" class="card p-3 shadow-sm">
    {% csrf_token %}
     {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
    <div class="row g-3">
      {% for field in form.visible_fields %}
        <div class="col-md-6">
          <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
          {{ field }}
          {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
          {% if field.errors %}
            <div class="invalid-feedback d-block">
              {{ field.errors|striptags }}
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    <hr class="my-4" />
    <h2 class="h6">Sistemas</h2>
    {{ sistema_formset.management_form }}
    {% if sistema_formset.non_form_errors %}
      <div class="alert alert-danger">
        {{ sistema_formset.non_form_errors }}
      </div>
    {% endif %}
    <div class="d-flex flex-column gap-3">
      {% for sistema_form in sistema_formset.forms %}
        <div class="card border-0 border-start border-4 border-primary-subtle">
          <div class="card-body">
            {% for hidden in sistema_form.hidden_fields %}{{ hidden }}{% endfor %}
            {% if sistema_form.non_field_errors %}
              <div class="alert alert-danger">{{ sistema_form.non_field_errors }}</div>
            {% endif %}
            <div class="row g-3 align-items-end">
              {% for field in sistema_form.visible_fields %}
                {% if field.name == 'DELETE' %}
                  <div class="col-md-2">
                    <div class="form-check mt-4">
                      {{ field }}
                      <label class="form-check-label" for="{{ field.id_for_label }}">Eliminar</label>
                    </div>
                  </div>
                {% else %}
                  <div class="col-md-4">
                    <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                      <div class="invalid-feedback d-block">{{ field.errors|striptags }}</div>
                    {% endif %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>

            {% with subs_formset=sistema_form.nested.subsistemas %}
              <div class="mt-4">
                <h3 class="h6">Subsistemas</h3>
                {{ subs_formset.management_form }}
                {% if subs_formset.non_form_errors %}
                  <div class="alert alert-danger">{{ subs_formset.non_form_errors }}</div>
                {% endif %}
                <div class="d-flex flex-column gap-3">
                  {% for subs_form in subs_formset.forms %}
                    <div class="card border-0 border-start border-warning-subtle">
                      <div class="card-body">
                        {% for hidden in subs_form.hidden_fields %}{{ hidden }}{% endfor %}
                        {% if subs_form.non_field_errors %}
                          <div class="alert alert-danger">{{ subs_form.non_field_errors }}</div>
                        {% endif %}
                        <div class="row g-3 align-items-end">
                          {% for field in subs_form.visible_fields %}
                            {% if field.name == 'DELETE' %}
                              <div class="col-md-2">
                                <div class="form-check mt-4">
                                  {{ field }}
                                  <label class="form-check-label" for="{{ field.id_for_label }}">Eliminar</label>
                                </div>
                              </div>
                            {% else %}
                              <div class="col-md-4">
                                <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                {{ field }}
                                {% if field.errors %}
                                  <div class="invalid-feedback d-block">{{ field.errors|striptags }}</div>
                                {% endif %}
                              </div>
                            {% endif %}
                          {% endfor %}
                        </div>

                        {% with item_formset=subs_form.nested.items %}
                          <div class="mt-4">
                            <h4 class="h6">√çtems mantenibles</h4>
                            {{ item_formset.management_form }}
                            {% if item_formset.non_form_errors %}
                              <div class="alert alert-danger">{{ item_formset.non_form_errors }}</div>
                            {% endif %}
                            <div class="d-flex flex-column gap-3">
                              {% for item_form in item_formset.forms %}
                                <div class="card border-0 border-start border-info-subtle">
                                  <div class="card-body">
                                    {% for hidden in item_form.hidden_fields %}{{ hidden }}{% endfor %}
                                    {% if item_form.non_field_errors %}
                                      <div class="alert alert-danger">{{ item_form.non_field_errors }}</div>
                                    {% endif %}
                                    <div class="row g-3 align-items-end">
                                      {% for field in item_form.visible_fields %}
                                        {% if field.name == 'DELETE' %}
                                          <div class="col-md-2">
                                            <div class="form-check mt-4">
                                              {{ field }}
                                              <label class="form-check-label" for="{{ field.id_for_label }}">Eliminar</label>
                                            </div>
                                          </div>
                                        {% else %}
                                          <div class="col-md-4">
                                            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                            {{ field }}
                                            {% if field.errors %}
                                              <div class="invalid-feedback d-block">{{ field.errors|striptags }}</div>
                                            {% endif %}
                                          </div>
                                        {% endif %}
                                      {% endfor %}
                                    </div>

                                    {% with parte_formset=item_form.nested.partes %}
                                      <div class="mt-4">
                                        <h5 class="h6">Partes</h5>
                                        {{ parte_formset.management_form }}
                                        {% if parte_formset.non_form_errors %}
                                          <div class="alert alert-danger">{{ parte_formset.non_form_errors }}</div>
                                        {% endif %}
                                        <div class="d-flex flex-column gap-3">
                                          {% for parte_form in parte_formset.forms %}
                                            <div class="card border-0 border-start border-secondary-subtle">
                                              <div class="card-body">
                                                {% for hidden in parte_form.hidden_fields %}{{ hidden }}{% endfor %}
                                                {% if parte_form.non_field_errors %}
                                                  <div class="alert alert-danger">{{ parte_form.non_field_errors }}</div>
                                                {% endif %}
                                                <div class="row g-3 align-items-end">
                                                  {% for field in parte_form.visible_fields %}
                                                    {% if field.name == 'DELETE' %}
                                                      <div class="col-md-2">
                                                        <div class="form-check mt-4">
                                                          {{ field }}
                                                          <label class="form-check-label" for="{{ field.id_for_label }}">Eliminar</label>
                                                        </div>
                                                      </div>
                                                    {% else %}
                                                      <div class="col-md-4">
                                                        <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                                        {{ field }}
                                                        {% if field.errors %}
                                                          <div class="invalid-feedback d-block">{{ field.errors|striptags }}</div>
                                                        {% endif %}
                                                      </div>
                                                    {% endif %}
                                                  {% endfor %}
                                                </div>
                                              </div>
                                            </div>
                                          {% endfor %}
                                        </div>
                                      </div>
                                    {% endwith %}
                                  </div>
                                </div>
                              {% endfor %}
                            </div>
                          </div>
                        {% endwith %}
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endwith %}
          </div>
        </div>
      {% endfor %}
    </div>

    <div class="mt-3">
      <button type="submit" class="btn btn-primary">Guardar</button>
      <a href="{% url 'activos:activos_list' %}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>


  {% if activo and activo.documentos.all %}
    <div class="card mt-4">
      <div class="card-body">
        <h2 class="h6">Documentos</h2>
        <ul class="list-unstyled mb-0">
          {% for doc in activo.documentos.all %}
            <li class="mb-2">
              {% if doc.archivo.url|is_pdf %}
                 <embed src="{% media_abs request doc.archivo.url %}" type="application/pdf" width="100%" height="400px" />
              {% else %}
                <a href="{% media_abs request doc.archivo.url %}" target="_blank">{{ doc.nombre|default:doc.archivo.name }}</a>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}